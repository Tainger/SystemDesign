## 设计一个Google Driver

近年来，云存储服务如Google Drive，Dropbox，Microsoft Onedrive和Apple Icloud等非常受欢迎。 在本章中，您被要求设计Google Drive 

让我们花点时间才能在开始设计之前了解谷歌驱动器。 Google Drive是一个文件存储和同步服务，可帮助您存储云中的文档，照片，视频和其他文件。 您可以从任何计算机，智能手机和平板电脑访问您的文件。 您可以轻松与朋友，家庭和同事共享这些文件[1]。 图15-1和15-2分别显示了浏览器和移动应用程序的Google Drive 


![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-1.png)

图 15-1

![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-2.png)

图 15-2

### 理解问题并且创建设计范围

设计Google Drive是一个大项目，因此请提出问题缩小范围很重要。

候选人：最重要的功能是什么？ 

面试官：上传和下载文件，文件同步和通知。 

候选人：这是一个移动应用程序，一个Web应用程序还是两者？ 

面试官：两者。 

候选人：支持的文件格式是什么？ 

面试官：任何文件类型。 

候选人：需要加密文件吗？ 

面试官：是的，必须加密存储中的文件。 

候选人：有文件大小限制吗？ 

面试官：是的，文件必须为10 GB或更小。 

候选人：产品有多少用户？ 

面试官：10M DAU 

在本章中，我们专注于以下功能:

- 添加文件。 添加文件的最简单方法是将文件拖放到Google Drive中。
- 下载文件。
- 跨多个设备同步文件。 当文件添加到一个设备时，它会自动同步到其他设备。
- 请参阅文件修订（See file revisions。
- 与您的朋友，家庭和同事分享文件。
- 在编辑，删除或与您共享文件时发送通知。

本章中未讨论的功能包括:

- Google Doc编辑和协作。 Google文档允许多个人同时编辑相同的文档。 这是我们的设计范围。

除了澄清要求外，了解非功能性要求非常重要:

- 可靠性。 可靠性对于存储系统非常重要。 数据丢失是不可接受的。
- 快速同步速度。 如果文件同步需要太多时间，用户将变得不耐烦并放弃产品。
- 带宽使用。 如果产品需要大量不必要的网络带宽，用户将不满意，特别是当它们在移动数据使用时。
- 可扩展性。 系统应该能够处理大量流量。
- 高可用性。 当某些服务器脱机时，用户仍然可以使用该系统，减慢，或具有意外的网络错误。

#### 信封估计 

- 假设申请有5000万签约用户和1000万DAU
- 用户获得10 GB的可用空间 
- 假设用户每天上传2个文件。 平均文件大小为500 kB
- 1：1读写写入比率 
- 分配的总空间：5000万* 10 GB = 500 PETABYTE 
- 上传API的QPS：1000万* 2上传/ 24小时/ 3600秒=〜240
- 峰值QPS = QPS * 2 = 480

### 提出高水平设计并获得认可

我们将使用略微不同的方法而不是从一开始就显示高级设计图。 我们将从简单的东西开始：在单个服务器中构建所有内容。 然后，逐渐扩大它以支持数百万用户。 通过执行此练习，它将刷新您的记忆，了解书中涵盖的一些重要主题 

让我们从下面列出的单个服务器设置开始:

- 用于上传和下载文件的Web服务器。
- 一个数据库，以跟踪元数据，如用户数据，登录信息，文件信息等。
- 存储文件的存储系统。 我们分配了1TB的存储空间来存储文件。

我们花了几个小时设置Apache Web服务器，MySQL数据库和一个名为Drive /作为根目录的目录来存储上传的文件。 在驱动器/目录下，有一个目录列表，称为名称空间。 每个命名空间包含该用户的所有上载文件。 服务器上的文件名保持与原始文件名相同。 通过加入命名空间和相对路径，可以唯一地识别每个文件或文件夹。

图15-3显示了/驱动器目录在左侧的左侧看起来的示例及其扩展视图。


![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-3.png)
图15-3

#### APIS
API是什么样的？ 我们主要需要3 API：上传文件，下载文件，获取文件修订。

1. 将文件上传到Google Drive 

支持两种类型的上传:

- 简单上传。 文件大小小时使用此上载类型。
- 更糟糕的上传。 当文件大小大而使用此上载类型，网络中断有很大的机会。

这是恢复上传API的一个例子:
https://api.example.com/files/upload?uploadType=resumable

参数:
- uploadType =可恢复
- 数据：要上载的本地文件

通过以下3个步骤[24]可恢复上传:
- 发送初始请求以检索可恢复的URL 
- 上传数据和监视上传状态
- 如果上传受到干扰，请恢复上传

2. 从Google Drive下载文件 

Example API: https://api.example.com/files/download

参数:
- 路径:下载路径参数

参数例子:
```json
{ 
  "path": "/recipes/soup/best_soup.txt"
}
```

3. 获取文件修订
   示例API：https://api.example.com/files/list_revisions 
参数
   
- 路径: 你想获得文件修订历史的文件路径。
- 限制: 返回最大数量的修订。


参数例子:
```json
{ 
  "path": "/recipes/soup/best_soup.txt",
  "limit": 20
}
```

所有API都需要用户身份验证并使用HTTPS。 安全套接字层（SSL）保护客户端和后端服务器之间的数据传输 

#### 远离单一服务器 

随着更多文件上传，最终您可以获得空间完整警报，如图15-4所示 


![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-4.png)

图15-4

仅剩10 MB的存储空间！ 这是紧急情况，因为用户无法再上传文件。 我想到的第一个解决方案是数据分片，因此将其存储在多个存储服务器上。 图15-5显示了一个基于user_id的分片示例。

![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-5.png)

图15-5

您需要花一整夜的时间来设置数据库分片并对其进行密切监视。 一切再次顺利进行。 您已经准备停止设计，但是您仍然担心在存储服务器中断的情况下潜在的数据丢失。 您四处询问，您的后端专家朋友Frank告诉您，许多领先的公司（例如Netflix和Airbnb）都使用Amazon S3进行存储。 “ Amazon Simple Storage Service（Amazon S3）是一种对象存储服务，可提供行业领先的可扩展性，数据可用性，安全性和性能” [3]。 您决定进行一些研究，看是否合适。

经过大量阅读后，您对S3存储系统有了很好的了解，并决定将文件存储在S3中。 Amazon S3支持同区域和跨区域复制。 区域是Amazon Web Services（AWS）拥有数据中心的地理区域。 如图15-6所示，可以在同一区域（左侧）和跨区域（右侧）上复制数据。 冗余文件存储在多个区域中，以防止数据丢失并确保可用性。 存储桶就像文件系统中的文件夹。

![img.png](/Users/rocky/study/github/SystemDesign/image/chapter-15/15-6.png)

图15-6

将文件存储在s3中，您可以终于睡个好觉，而不担心数据丢失。 为了停止未来发生类似的问题，您决定对您可以改进的区域进行进一步研究。 以下是您找到的几个区域:
- Load Balancer：添加负载均衡器以分发网络流量。 负载均衡器确保均匀分布式流量，如果Web服务器衰减，则会重新分配流量 
- Web服务器：添加负载均衡器后，可以轻松地添加/删除更多的Web服务器，具体取决于流量负载 
- 元数据数据库：将数据库移出服务器，以避免单点故障。 同时，设置数据复制和分片以满足可用性和可伸缩性要求 
- 文件存储：Amazon S3用于文件存储。 为确保可用性和耐用性，文件在两个单独的地理区域中复制 

在应用上述改进后，您已成功地解耦了Web服务器，元数据数据库和从单个服务器的文件存储。 更新的设计如图15-7所示 









